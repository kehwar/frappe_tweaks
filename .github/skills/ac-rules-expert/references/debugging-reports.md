# Debugging and Auditing Reports

This document describes the reports available for debugging, auditing, and troubleshooting AC Rules.

## Available Reports

All reports require **System Manager** role.

### 1. AC Permissions Report

**Path**: Tweaks > AC Permissions  
**Reference DocType**: AC Rule  
**Purpose**: System-wide access audit showing who has access to what

**Description**:
Flat view of all access control rules resolved to actual users. Shows one row per (user, resource, resource_filter, rule_type) combination with aggregated actions from all matching enabled rules within valid date ranges.

**Columns**:
- **User**: Full name (resolved from principal filters)
- **Resource**: AC Resource title (DocType or Report)
- **Rule Type**: "Permit" or "Forbid" (ðŸš« emoji for Forbid)
- **Distinct Resource Query Filters**: Query Filter or "All" (âš ï¸ for exceptions)
- **Actions**: Comma-separated list (or Y/N when action filter specified)

**Filters**:
- `action` (optional): Shows Y/N for specific action instead of action list
- `principal_filter` (optional): Only show users matching this Query Filter

**Use Cases**:
1. System-wide access audit (who has access to what)
2. Action-specific auditing (filter by action to see Y/N per combination)
3. User-specific review (filter by principal_filter for targeted analysis)
4. Gap/over-permission detection

**Algorithm**:
1. Load enabled AC Rules within valid date range
2. Resolve principal filters to users
3. Get resource filters
4. Create rows for each (user, resource, resource_filter, rule_type)
5. Aggregate actions from matching rules

**Example Usage**:
```python
# View all permissions
# Navigate to: Tweaks > AC Permissions

# View who can "approve" quotations
# Set filter: action = "approve"

# View permissions for sales team
# Set filter: principal_filter = "Sales Team"
```

### 2. Query Filters Report

**Path**: Tweaks > Query Filters  
**Reference DocType**: Query Filter  
**Purpose**: Debug and understand how Query Filters evaluate to SQL

**Description**:
Lists all enabled Query Filter documents with their calculated SQL expressions. Useful for debugging and understanding how Query Filters are evaluated in different contexts.

**Columns**:
- **Name**: Link to the Query Filter document (hidden by default)
- **Filter Name**: Human-readable name of the filter
- **Reference Type**: Type of reference (Report or DocType)
- **Reference**: The Report or DocType this filter applies to (clickable link)
- **Reference Document Name**: Specific document name (for single-record filters, clickable link)
- **Type**: Filter type (JSON, Python, or SQL)
- **Filter**: Filter code definition (click "View Filter" button to see in dialog)
- **SQL**: The SQL WHERE clause generated by the filter (line breaks removed for display)

**Filters**:
- `impersonate_user` (optional): User to impersonate when calculating SQL

**Impersonation Feature**:
When `impersonate_user` is set, the report switches to the specified user's context to calculate SQL, then switches back. This is useful for:
- Testing how filters evaluate for specific users
- Debugging permission-related issues
- Understanding context-dependent filter behavior (e.g., Python filters using `frappe.session.user`)

**Features**:
- Only shows enabled Query Filters (disabled filters are excluded)
- Calculates SQL in impersonated user context if specified
- Error handling: Shows "ERROR: <message>" if SQL calculation fails
- Original user context is always restored via finally block
- Filter column includes "View Filter" button to display code in dialog

**Example Usage**:
```python
# View all enabled filters
# Navigate to: Tweaks > Query Filters

# Test as another user
# Set filter: impersonate_user = "john@example.com"
# This shows how filters evaluate for john@example.com

# Debug broken filters
# Look for "ERROR:" prefix in SQL column
```

### 3. AC Principal Query Filters Report

**Path**: Tweaks > AC Principal Query Filters  
**Reference DocType**: Query Filter  
**Purpose**: Understand which users are matched by each principal filter

**Description**:
Shows each principal query filter (User, Role, User Group, Role Profile) with the SQL used to determine users and lists all matching users.

**Report Structure**:
- Rows: One row per (Query Filter, User) combination
- Columns: Query Filter, Reference DocType, Reference DocName, Filter Type, Filter, SQL, User

**Columns**:
- **Filter Name**: Human-readable name of the Query Filter
- **Query Filter**: Link to Query Filter document (hidden)
- **User**: Full name of matched user
- **User ID**: User ID (hidden)
- **Reference DocType**: DocType the filter references (User, Role, User Group, Role Profile)
- **Reference DocName**: Specific document name if applicable
- **Filter Type**: JSON, Python, or SQL
- **Filter**: Filter code definition
- **SQL**: The SQL WHERE clause used to match users

**Features**:
- Only shows principal filters (User, Role, User Group, Role Profile reference doctypes)
- Only includes enabled Query Filters
- Only includes enabled users
- Error handling: Skips filters that fail and logs errors

**Example Usage**:
```python
# View all principal filters and their matched users
# Navigate to: Tweaks > AC Principal Query Filters

# See which users are in "Sales Team" filter
# Find filter_name = "Sales Team" in the report
```

## Common Debugging Workflows

### Workflow 1: Why does User X have access to Resource Y?

1. Open **AC Permissions Report**
2. Set filter: `principal_filter` = (filter that matches User X)
3. Look for Resource Y in the results
4. Check which rules grant access (Permit) or deny access (Forbid)
5. Examine the resource filters to understand conditions

### Workflow 2: Why doesn't User X have access to Resource Y?

1. Open **AC Permissions Report**
2. Set filter: `principal_filter` = (filter that matches User X)
3. Look for Resource Y in the results
4. If not present: No Permit rules match OR Forbid rules block access
5. Open **AC Principal Query Filters Report** to verify user matches principal filters
6. Check if Forbid rules are blocking access

### Workflow 3: Test a Query Filter

1. Open **Query Filters Report**
2. Find the filter you want to test
3. Check the SQL column to see generated SQL
4. If SQL looks wrong or shows ERROR, debug the filter code
5. To test as another user, set `impersonate_user` filter

### Workflow 4: Who matches a Principal Filter?

1. Open **AC Principal Query Filters Report**
2. Find the filter by name
3. See all users that match this filter
4. Verify the SQL is correct

### Workflow 5: Audit all permissions for an action

1. Open **AC Permissions Report**
2. Set filter: `action` = "approve" (or any action)
3. Report shows Y/N for each (user, resource) combination
4. Quickly identify who can perform this action where

### Workflow 6: Verify Python Filter Behavior

1. Open **Query Filters Report**
2. Find your Python filter
3. Set `impersonate_user` to test user
4. Check SQL column to see how filter evaluates for that user
5. Verify the SQL matches expectations

## Performance Tips

### For AC Permissions Report

- Use `principal_filter` to narrow down results
- Use `action` filter when auditing specific actions
- Report can be slow with many rules/users - use filters to limit scope

### For Query Filters Report

- Impersonation adds overhead - use only when needed
- Python filters are evaluated each time - check for efficiency
- SQL filters are fastest - prefer them when possible

### For AC Principal Query Filters Report

- Report only includes principal filters (User, Role, User Group, Role Profile)
- Only enabled filters and users are included
- Report can be slow with many filters - review regularly

## Troubleshooting Report Issues

### AC Permissions Report shows no data

**Possible causes**:
1. No enabled AC Rules exist
2. All rules are outside valid date range
3. Principal filters don't match any users
4. `principal_filter` filter is set but doesn't match anyone

**Solutions**:
- Check AC Rules are enabled
- Check valid_from/valid_upto dates
- Review principal filters in rules
- Remove filters and retry

### Query Filters Report shows ERROR

**Possible causes**:
1. Invalid filter syntax (JSON/Python/SQL)
2. Reference DocType doesn't exist
3. Python filter has runtime error
4. Missing frappe.session.user or other context

**Solutions**:
- Check filter syntax in Query Filter document
- Verify reference DocType exists
- Test Python filters in console first
- Check for context dependencies (e.g., frappe.session.user)

### AC Principal Query Filters Report is empty

**Possible causes**:
1. No principal filters exist
2. All principal filters are disabled
3. Filters don't match any enabled users

**Solutions**:
- Create Query Filters with reference_doctype in [User, Role, User Group, Role Profile]
- Enable Query Filters
- Check if filters have users (run SQL manually)

## Related Documentation

- **Core Components**: [core-components.md](core-components.md) - AC Rule, Query Filter, AC Resource
- **Rule Evaluation**: [rule-evaluation.md](rule-evaluation.md) - How rules are evaluated
- **Troubleshooting**: [troubleshooting.md](troubleshooting.md) - General troubleshooting guide
