name: CI

on:
  push:
    branches: [develop, main, master]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      mariadb:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_CHARACTER_SET_SERVER: utf8mb4
          MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis-cache:
        image: redis:alpine
        ports:
          - 6379:6379

      redis-queue:
        image: redis:alpine
        ports:
          - 6380:6379

      redis-socketio:
        image: redis:alpine
        ports:
          - 6381:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          check-latest: true

      - name: Add to PATH
        run: echo "/home/runner/.local/bin" >> $GITHUB_PATH

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            redis-tools \
            mariadb-client \
            wkhtmltopdf \
            libcups2-dev

      - name: Install Frappe bench
        run: |
          pip install frappe-bench

      - name: Initialize bench with custom Frappe
        run: |
          bench init --skip-redis-config-generation --frappe-path https://github.com/kehwar/frappe --frappe-branch version-15 frappe-bench

      - name: Setup hosts
        run: |
          echo "127.0.0.1 test.localhost" | sudo tee -a /etc/hosts

      - name: Get ERPNext
        working-directory: ./frappe-bench
        run: |
          bench get-app https://github.com/kehwar/erpnext --branch version-15

      - name: Create site
        working-directory: ./frappe-bench
        run: |
          bench new-site test.localhost \
            --db-root-password root \
            --admin-password admin \
            --no-mariadb-socket

      - name: Install ERPNext
        working-directory: ./frappe-bench
        run: |
          bench --site test.localhost install-app erpnext

      - name: Get app
        working-directory: ./frappe-bench
        run: |
          bench get-app $GITHUB_WORKSPACE

      - name: Install app
        working-directory: ./frappe-bench
        run: |
          bench --site test.localhost install-app tweaks

      - name: Run tests
        working-directory: ./frappe-bench
        run: |
          bench --site test.localhost run-tests --app tweaks
